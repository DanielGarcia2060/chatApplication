!function(a){a.module("chat_room",["ngRoute"]).run(["userService",function(a){a.auth({},"/verify"),console.info("module initialized ok")}]).config(["$routeProvider","$locationProvider","$compileProvider",function(a,b,c){a.when("/chat",{templateUrl:"/templates/tpl_home"}).when("/chat/login",{templateUrl:"/templates/tpl_login",controller:"loginController"}).when("/chat/register",{templateUrl:"/templates/tpl_register",controller:"registerController"}).when("/chat/account",{templateUrl:"/templates/tpl_account",controller:"accountController"}).when("/chat/:type",{templateUrl:"/templates/tpl_chat",controller:"chatController",resolve:{delay:["$q","$timeout",function(a,b){var c=a.defer();return b(c.resolve,300),c.promise}]}}).when("/chat/:type/:friendname/?",{templateUrl:"/templates/tpl_chat",controller:"chatController",resolve:{delay:["$q","$timeout",function(a,b){var c=a.defer();return b(c.resolve,300),c.promise}]}}).otherwise({redirectTo:"/chat"}),b.html5Mode({enabled:!0}),c.debugInfoEnabled(!1)}]).controller("accountController",["$scope","userService","User",function(a,b,c){a.user=c.get(),a.friendName="",a.foundFriend="",a.findFriend=function(){a.findFriend&&b.find(a.friendName).then(function(b){a.foundFriend=b},function(b){a.foundFriend=b})},a.sendInvitation=function(){a.foundFriend&&"Oops, sorry!"!==a.foundFriend&&b.invite(a.foundFriend).then(function(){a.foundFriend=""},function(){a.foundFriend="Oops, sorry!"})},a.accept=function(d){b.handle(d,"accept").then(function(){c.get().friends.push(d);var a=c.get().requests.indexOf(d);c.get().requests.splice(a,1)},function(){a.foundFriend="Oops sorry!"})},a.reject=function(a){b.handle(a,"reject")}}]).controller("chatController",["$scope","socketService","User","MessagesCache","$routeParams",function(a,b,c,d,e){a.rooms=d.keys(),a.friends=c.get().friends,a.invite="",a.usersSubscribed=e.friendname||"",a.sendAs="txt",a.message={txt:"",scribble:"",initX:0,initY:0,type:e.type,friends:(e.friendname?e.friendname+"/":"")+c.get().username},a.send=function(){if(/\+/g.test(e.friendname)){var d=a.usersSubscribed.split("+").sort().join("/")+"/"+c.get().username;a.message.friends=d}b.send(a.message),a.message.scribble="",a.message.txt=""},a.isRoom=function(a){return a==="/chat/"+e.type+(e.friendname?"/"+e.friendname:"")},a.isActive=function(a){return-1!==b.getFriends().indexOf(a)},a.isJoined=function(b){return-1!==a.usersSubscribed.indexOf(b)},a.$watch(d.keys,function(b){a.rooms=b}),a.$watch(function(){return a.usersSubscribed=e.friendname||"",e.friendname},function(b){return b?a.invite="+":void(a.invite="")})}]).controller("headerController",["$scope","User","userService","$window",function(a,b,c,d){a.SORRY_THERE_WAS_A_PROBLEM="Chat App :)",a.state=function(){return b.exists()},a.unauth=function(){c.unauth().then(function(){d.location.reload()})}}]).controller("loginController",["$scope","userService",function(a,b){a.errorMsg=void 0,a.user={username:"",password:""},a.errorMsg=void 0,a.login=function(){var c=b.auth(a.user,"/login");c.then(function(){b.redirect("/chat/account")},function(b){a.errorMsg=b})}}]).controller("registerController",["$scope","userService",function(a,b){a.user={username:"",user_email:"",password:"",friends:[]},a.errorMsg=void 0,a.register=function(){var c=b.auth(a.user,"/register");c.then(function(){b.redirect("/chat/account")},function(b){a.errorMsg=b})}}]).directive("chatRoomWindow",["$window","MessagesCache","$location",function(b,c,d){function e(e,f){function g(){var a=Math.max(b.innerHeight-245,120)+"px";return f.children().css({height:a}),f.children()[0].scrollTop=f.children()[0].scrollHeight,"a"}e.$watch(g,a.noop),a.element(b).bind("resize",g),e.$on("$routeChangeSuccess",function(){setTimeout(function(){f.parent().removeClass("white")},300);var a=d.path(),b=c.get(a);f.append(b)}),e.$on("$routeChangeStart",function(){f.parent().addClass("white")})}return{restrict:"A",link:e,scope:!1}}]).directive("writeScribble",function(){return{restrict:"A",scope:!1,link:function(a,b){function c(){g=[],a.message.scribble="",b[0].width=b[0].width}function d(a,b,c,d){h.moveTo(a,b),h.lineTo(c,d),h.strokeStyle="#000",h.stroke()}var e,f,g=[],h=b[0].getContext("2d"),i=!1;b.bind("mousedown",function(b){void 0!==b.offsetX?(e=b.offsetX,f=b.offsetY):(e=b.layerX-b.currentTarget.offsetLeft,f=b.layerY-b.currentTarget.offsetTop),a.message.initX=e,a.message.initY=f,c(),h.beginPath(),i=!0}),b.bind("mousemove",function(a){i&&(void 0!==a.offsetX?(currentX=a.offsetX,currentY=a.offsetY):(currentX=a.layerX-a.currentTarget.offsetLeft,currentY=a.layerY-a.currentTarget.offsetTop),d(e,f,currentX,currentY),g.push(currentX-e,currentY-f),e=currentX,f=currentY)}),b.bind("mouseup",function(){i=!1,a.message.scribble=g.join(",")})}}}).directive("triggerMenu",function(){return{restrict:"C",link:function(a,b){var c=void 0;b.on("click",function(){b.hasClass("open")?b.removeClass("open"):(a.$digest(),b.addClass("open"))}),b.on("mouseleave",function(){c=setTimeout(function(){b.removeClass("open"),c=void 0},800)}),b.on("mouseenter",function(){c&&(clearTimeout(c),c=void 0)})}}}).factory("socketService",["$rootScope","User","MessagesCache","$timeout",function(b,c,d,e){function f(b,f){if("msgFromServer"===b){var g,h="public"===f.type?"/chat/public":function(a){var b=a.split("/"),d=b.indexOf(c.get().username);return b.splice(d,1),"/chat/private/"+b.sort().join("+")}(f.friends),i=d.get(h),j=a.element("<div></div>").addClass("msg").addClass("justDisplayed");if(j.append(a.element('<span class="from">'+f.from+"</span>")),f.txt){var k=a.element("<p></p>").text(f.txt);j.append(k)}if(f.scribble){var l=f.initX||0,m=f.initY||0,n=f.scribble.split(","),g=a.element("<canvas></canvas>"),o=g[0].getContext("2d");for(o.moveTo(l,m),o.beginPath();n.length;)l+=parseInt(n.shift()),m+=parseInt(n.shift()),o.lineTo(l,m);o.strokeStyle="#000",o.stroke(),j.append(g)}f.from==c.get().username&&j.addClass("mine"),i.append(j),e(function(){j.removeClass("justDisplayed"),j=null,scribble=null},10)}}function g(){m=io();var a={message:function(a){f("msgFromServer",a)},info:function(a){f("info",a)},disconnect:function(){console.warn("socket out"),f("info","Connection has finished")},initSocket:function(a){n=a.rooms,friendsConnected=a.friends},friendConnected:function(a){-1===friendsConnected.indexOf(a)&&friendsConnected.push(a)},friendDisconnected:function(a){var b=friendsConnected.indexOf(a);-1!==b&&friendsConnected.splice(b,1)}};for(var b in a)m.on(b,a[b])}function h(a){m&&(a.scribble||a.txt)&&m.emit("message",a)}function i(){m&&m.disconnect(),m=null}function j(a){m.emit("createRoom",a)}function k(){return n}function l(){return friendsConnected}var m=null,n=[];return friendsConnected=[],{init:g,send:h,disconnect:i,createRoom:j,getRooms:k,getFriends:l}}]).factory("userService",["$http","$location","$templateCache","$q","User","socketService",function(a,b,c,d,e,f){function g(a){var b=[];for(var c in a){var d=a[c];b.push(encodeURIComponent(c)+"="+encodeURIComponent(null==d?"":d))}var e=b.join("&").replace(/%20/g,"+");return e}function h(b,h){var i=d.defer(),j=g(b);return a.post(h,j,n).success(function(a){e.set(a.user),c.removeAll(),f.init(),i.resolve("Success "+h.replace("/",""))}).error(function(a){i.reject(a.error)}),i.promise}function i(b){var c=d.defer();return a.post("/friendapi",{friendname:b,action:"find"}).success(function(a){c.resolve(a.friendname||"not Found")}).error(function(){c.reject()}),c.promise}function j(b){var c=d.defer();return a.post("/friendapi",{friendname:b,action:"invite"}).success(function(){c.resolve("done")}).error(function(){c.reject("error")}),c.promise}function k(){var b=d.defer();return a.post("/logout").success(function(){e.clear(),c.removeAll(),f.disconnect(),b.resolve("Successfull logout")}).error(function(a){console.warn("Error at logout",a),b.reject("There was a problem at logout")}),b.promise}function l(a){b.path(a)}function m(b,c){var e=d.defer();return a.post("friendapi",{related:"friendRequest",action:c,sender:b}).success(function(){e.resolve()}).error(function(){e.reject()}),e.promise}var n={headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"}};return{auth:h,unauth:k,redirect:l,find:i,invite:j,handle:m}}]).filter("prettyRoute",function(){return function(a){return a.replace(/\/chat|\/private|\//gim,"")}}).service("MessagesCache",["$cacheFactory",function(b){var c=b("MessagesCache"),d=[];return{put:function(a,b){var e=d.indexOf(a);return-1===e?(d.push(a),c.put(a,b)):c.get(a)},get:function(b){return c.get(b)||this.put(b,a.element('<div id="chat_window"></div>'))},remove:function(a){var b=d.indexOf(a);return-1!==b?(d.splice(b,1),c.remove(a)):void 0},keys:function(){return d}}}]).service("User",function(){var a={friends:[]};this.set=function(b){return a=b,!0},this.get=function(){return a},this.clear=function(){this.set(null)},this.exists=function(){return!!a.username}})}(angular);